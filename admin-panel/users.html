<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت کاربران - پنل مدیریت</title>
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>مدیریت کاربران</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="openAddUserModal()">
                        <i class="fas fa-plus"></i>
                        افزودن کاربر جدید
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Filters -->
                <div class="filters-section">
                    <div class="filter-group">
                        <label for="searchUsers">جستجو:</label>
                        <input type="text" id="searchUsers" placeholder="جستجو بر اساس نام، کد ملی یا شماره همراه...">
                    </div>
                    <div class="filter-group">
                        <label for="userTypeFilter">نوع کاربر:</label>
                        <select id="userTypeFilter">
                            <option value="">همه کاربران</option>
                            <option value="admin">مدیران</option>
                            <option value="user">کاربران عادی</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-secondary" onclick="loadUsers()">
                            <i class="fas fa-search"></i>
                            جستجو
                        </button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>کاربر</th>
                                <th>کد ملی</th>
                                <th>شماره همراه</th>
                                <th>کیف پول</th>
                                <th>نوع کاربر</th>
                                <th>تاریخ عضویت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    در حال بارگذاری...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <!-- Pagination will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>افزودن کاربر جدید</h2>
                <button class="close-btn" onclick="closeAddUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">نام *</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">نام خانوادگی *</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nationalId">کد ملی *</label>
                            <input type="text" id="nationalId" name="nationalId" required maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="phone">شماره همراه *</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="birthDate">تاریخ تولد</label>
                            <input type="date" id="birthDate" name="birthDate">
                        </div>
                        <div class="form-group">
                            <label for="profileImage">تصویر پروفایل</label>
                            <input type="file" id="profileImage" name="profileImage" accept="image/*">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="walletRial">کیف پول ریالی</label>
                            <input type="number" id="walletRial" name="walletRial" step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="walletGold">کیف پول طلا (به صورت)</label>
                            <input type="number" id="walletGold" name="walletGold" step="0.0001" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="walletIncome">کیف پول درآمد</label>
                        <input type="number" id="walletIncome" name="walletIncome" step="0.01" min="0" value="0">
                    </div>

                    <!-- Admin Section -->
                    <div class="admin-section" id="adminSection" style="display: none;">
                        <h3>اطلاعات مدیر</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username">نام کاربری *</label>
                                <input type="text" id="username" name="username">
                            </div>
                            <div class="form-group">
                                <label for="email">ایمیل *</label>
                                <input type="email" id="email" name="email">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="password">رمز عبور *</label>
                                <input type="password" id="password" name="password">
                            </div>
                            <div class="form-group">
                                <label for="role">نقش</label>
                                <select id="role" name="role">
                                    <option value="admin">مدیر</option>
                                    <option value="moderator">ناظر</option>
                                    <option value="super_admin">مدیر کل</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isAdmin" onchange="toggleAdminSection()">
                            این کاربر مدیر است
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">انصراف</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            ذخیره کاربر
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ویرایش کاربر</h2>
                <button class="close-btn" onclick="closeEditUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="userId">
                    <!-- Same form fields as add user -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFirstName">نام *</label>
                            <input type="text" id="editFirstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="editLastName">نام خانوادگی *</label>
                            <input type="text" id="editLastName" name="lastName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editNationalId">کد ملی *</label>
                            <input type="text" id="editNationalId" name="nationalId" required maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="editPhone">شماره همراه *</label>
                            <input type="tel" id="editPhone" name="phone" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editBirthDate">تاریخ تولد</label>
                            <input type="date" id="editBirthDate" name="birthDate">
                        </div>
                        <div class="form-group">
                            <label for="editProfileImage">تصویر پروفایل</label>
                            <input type="file" id="editProfileImage" name="profileImage" accept="image/*">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editWalletRial">کیف پول ریالی</label>
                            <input type="number" id="editWalletRial" name="walletRial" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="editWalletGold">کیف پول طلا (به صورت)</label>
                            <input type="number" id="editWalletGold" name="walletGold" step="0.0001" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editWalletIncome">کیف پول درآمد</label>
                        <input type="number" id="editWalletIncome" name="walletIncome" step="0.01" min="0">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">انصراف</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            ذخیره تغییرات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/common.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/load-sidebar.js"></script>
    <script src="js/sidebar.js"></script>
    
    <script>
        let users = [];
        let currentPage = 1;
        const limit = 20;

        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('searchUsers').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadUsers();
                }
            });

            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('editUserForm').addEventListener('submit', handleEditUser);
        }

        async function loadUsers() {
            try {
                showLoading();
                
                const search = document.getElementById('searchUsers').value;
                const userType = document.getElementById('userTypeFilter').value;
                
                let url = 'http://localhost:3000/api/users?';
                const params = new URLSearchParams();
                
                if (search) params.append('search', search);
                if (userType) params.append('user_type', userType);
                params.append('page', currentPage);
                params.append('limit', limit);
                
                if (params.toString()) {
                    url += params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    users = data.data.users;
                    renderUsers();
                    renderPagination(data.data.pagination);
                } else {
                    showNotification('خطا در بارگذاری کاربران', 'error');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('خطا در بارگذاری کاربران', 'error');
            }
        }

        function renderUsers() {
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            <i class="fas fa-users"></i>
                            <p>هیچ کاربری یافت نشد</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">
                                ${user.profile_image ? 
                                    `<img src="https://files.iranche.com/${user.profile_image}" alt="${user.first_name} ${user.last_name}">` :
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                            <div class="user-details">
                                <span class="user-name">${user.first_name} ${user.last_name}</span>
                                <span class="user-id">ID: ${user.id}</span>
                            </div>
                        </div>
                    </td>
                    <td>${user.national_id}</td>
                    <td>${user.phone}</td>
                    <td>
                        <div class="wallet-info">
                            <div class="wallet-item">
                                <span class="wallet-label">ریال:</span>
                                <span class="wallet-value">${formatNumber(user.wallet_rial)} ریال</span>
                            </div>
                            <div class="wallet-item">
                                <span class="wallet-label">طلا:</span>
                                <span class="wallet-value">${user.wallet_gold} گرم</span>
                            </div>
                            <div class="wallet-item">
                                <span class="wallet-label">درآمد:</span>
                                <span class="wallet-value">${formatNumber(user.wallet_income)} ریال</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="user-type-badge ${user.is_admin ? 'admin' : 'user'}">
                            ${user.is_admin ? 'مدیر' : 'کاربر عادی'}
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="editUser(${user.id})" title="ویرایش">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteUser(${user.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            if (pagination.totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }

            let html = '<div class="pagination-controls">';
            
            // Previous button
            if (pagination.page > 1) {
                html += `<button class="btn btn-sm" onclick="changePage(${pagination.page - 1})">
                    <i class="fas fa-chevron-right"></i>
                    قبلی
                </button>`;
            }

            // Page numbers
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.totalPages, pagination.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="btn btn-sm ${i === pagination.page ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            // Next button
            if (pagination.page < pagination.totalPages) {
                html += `<button class="btn btn-sm" onclick="changePage(${pagination.page + 1})">
                    بعدی
                    <i class="fas fa-chevron-left"></i>
                </button>`;
            }

            html += '</div>';
            paginationDiv.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            loadUsers();
        }

        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'flex';
            document.getElementById('addUserForm').reset();
            document.getElementById('adminSection').style.display = 'none';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        function openEditUserModal() {
            document.getElementById('editUserModal').style.display = 'flex';
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        function toggleAdminSection() {
            const isAdmin = document.getElementById('isAdmin').checked;
            const adminSection = document.getElementById('adminSection');
            adminSection.style.display = isAdmin ? 'block' : 'none';
            
            // Make admin fields required if admin is checked
            const adminFields = ['username', 'email', 'password'];
            adminFields.forEach(field => {
                const input = document.getElementById(field);
                input.required = isAdmin;
            });
        }

        async function handleAddUser(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const isAdmin = document.getElementById('isAdmin').checked;
                
                const userData = {
                    first_name: formData.get('firstName'),
                    last_name: formData.get('lastName'),
                    national_id: formData.get('nationalId'),
                    phone: formData.get('phone'),
                    birth_date: formData.get('birthDate'),
                    wallet_rial: parseFloat(formData.get('walletRial')) || 0,
                    wallet_gold: parseFloat(formData.get('walletGold')) || 0,
                    wallet_income: parseFloat(formData.get('walletIncome')) || 0,
                    is_admin: isAdmin
                };

                if (isAdmin) {
                    userData.username = formData.get('username');
                    userData.email = formData.get('email');
                    userData.password = formData.get('password');
                    userData.role = formData.get('role');
                }

                const response = await fetch('http://localhost:3000/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('کاربر با موفقیت اضافه شد', 'success');
                    closeAddUserModal();
                    loadUsers();
                } else {
                    showNotification(result.message || 'خطا در افزودن کاربر', 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('خطا در افزودن کاربر', 'error');
            }
        }

        async function handleEditUser(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const userId = document.getElementById('editUserId').value;
                
                const userData = {
                    first_name: formData.get('firstName'),
                    last_name: formData.get('lastName'),
                    national_id: formData.get('nationalId'),
                    phone: formData.get('phone'),
                    birth_date: formData.get('birthDate'),
                    wallet_rial: parseFloat(formData.get('walletRial')) || 0,
                    wallet_gold: parseFloat(formData.get('walletGold')) || 0,
                    wallet_income: parseFloat(formData.get('walletIncome')) || 0
                };

                const response = await fetch(`http://localhost:3000/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('کاربر با موفقیت ویرایش شد', 'success');
                    closeEditUserModal();
                    loadUsers();
                } else {
                    showNotification(result.message || 'خطا در ویرایش کاربر', 'error');
                }
            } catch (error) {
                console.error('Error editing user:', error);
                showNotification('خطا در ویرایش کاربر', 'error');
            }
        }

        async function editUser(userId) {
            try {
                const response = await fetch(`http://localhost:3000/api/users/${userId}`);
                const result = await response.json();
                
                if (result.success) {
                    const user = result.data;
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editFirstName').value = user.first_name;
                    document.getElementById('editLastName').value = user.last_name;
                    document.getElementById('editNationalId').value = user.national_id;
                    document.getElementById('editPhone').value = user.phone;
                    document.getElementById('editBirthDate').value = user.birth_date;
                    document.getElementById('editWalletRial').value = user.wallet_rial;
                    document.getElementById('editWalletGold').value = user.wallet_gold;
                    document.getElementById('editWalletIncome').value = user.wallet_income;
                    
                    openEditUserModal();
                } else {
                    showNotification('خطا در بارگذاری اطلاعات کاربر', 'error');
                }
            } catch (error) {
                console.error('Error loading user:', error);
                showNotification('خطا در بارگذاری اطلاعات کاربر', 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('آیا از حذف این کاربر اطمینان دارید؟')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('کاربر با موفقیت حذف شد', 'success');
                    loadUsers();
                } else {
                    showNotification(result.message || 'خطا در حذف کاربر', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('خطا در حذف کاربر', 'error');
            }
        }

        function showLoading() {
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        در حال بارگذاری...
                    </td>
                </tr>
            `;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('fa-IR').format(num);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fa-IR');
        }
    </script>
</body>
</html>

